name: build-and-push-docker-image
on: 
  push:
    branches:
      - master
      - dev
      - refactor-*
  pull_request:
    branches:
      - master
      - dev

env:
  PUSH_COMMIT_RANGE: ${{ github.event.before }}...${{ github.event.after }}
  PR_COMMIT_RANGE: ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }}
  DOCKER_USER: ${{ secrets.DOCKER_HUB_USERNAME }}
  DOCKER_PASS: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
  FORCE_PUSH: "true"

jobs:
  base-os:
    runs-on: ubuntu-latest
    env:
      DH_REPO: "cloudsuitetest/debian"
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images-base-os.sh"
  
  java:
    runs-on: ubuntu-latest
    needs: base-os
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        include:
          - tag: "adoptopenjdk8"
            platform: "linux/amd64,linux/arm64"
          - tag: "openjdk11"
            platform: "linux/amd64,linux/arm64,linux/riscv64"
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./commons/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}
    
  mysql:
    runs-on: ubuntu-latest
    needs: base-os
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["mariadb-10.3"]
        platform: ["linux/amd64,linux/arm64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./commons/${{ github.job }}" # TODO: Unify the name
          DBX_PLATFORM: ${{ matrix.platform }}
    
  memcached:
    runs-on: ubuntu-latest
    needs: base-os
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["1.6.6"]
        platform: ["linux/amd64,linux/arm64,linux/riscv64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./commons/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}
    
  hhvm:
    runs-on: ubuntu-latest
    needs: base-os
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["3.30"]
        platform: ["linux/amd64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./commons/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}

  graphite-statsd:
    runs-on: ubuntu-latest
    needs: base-os
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["0.9.15"]
        platform: ["linux/amd64,linux/arm64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./commons/${{ github.job }}" # TODO: unify the path
          DBX_PLATFORM: ${{ matrix.platform }}
  
  faban:
    runs-on: ubuntu-latest
    needs: java
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["1.4"]
        platform: ["linux/amd64,linux/arm64,linux/riscv64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./commons/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}
    
  spark:
    runs-on: ubuntu-latest
    needs: java
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["2.4.5"]
        platform: ["linux/amd64,linux/arm64,linux/riscv64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./commons/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}

  siege:
    runs-on: ubuntu-latest
    needs: java
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["4.0.3rc3"]
        platform: ["linux/amd64,linux/arm64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./commons/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}

  cassandra:
    runs-on: ubuntu-latest
    needs: java
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["3.11.6"]
        platform: ["linux/amd64,linux/arm64,linux/riscv64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./commons/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}

  hadoop:
    runs-on: ubuntu-latest
    needs: java
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["2.10.1"]
        platform: ["linux/amd64,linux/arm64,linux/riscv64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./commons/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}

  data-analytics:
    runs-on: ubuntu-latest
    needs: hadoop
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["4.0"]
        platform: ["linux/amd64,linux/arm64,linux/riscv64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./benchmarks/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}

  data-caching:
    runs-on: ubuntu-latest
    needs: memcached
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        include:
          - tag: "server"
            platform: "linux/amd64,linux/arm64,linux/riscv64"
          - tag: "client"
            platform: "linux/amd64,linux/arm64"
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./benchmarks/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}

  data-serving:
    runs-on: ubuntu-latest
    needs: cassandra
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["server", "client"]
        platform: ["linux/amd64,linux/arm64,linux/riscv64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./benchmarks/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}

  django-workload:
    runs-on: ubuntu-latest
    needs: [cassandra, graphite-statsd, memcached, siege]
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["cassandra", "graphite", "memcached", "siege"]
        platform: ["linux/amd64,linux/arm64"]
        include:
          - tag: "uwsgi"
            platform: "linux/amd64,linux/arm64"
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./benchmarks/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}

  fb-oss-performance:
    runs-on: ubuntu-latest
    needs: [mysql, siege, hhvm]
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["latest"]
        platform: ["linux/amd64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./benchmarks/${{ github.job }}"
          DBX_PLATFORM: ${{ matrix.platform }}
  
  graph-analytics:
    runs-on: ubuntu-latest
    needs: spark
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["4.0"]
        platform: ["linux/amd64,linux/arm64,linux/riscv64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./benchmarks/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}


  in-memory-analytics:
    runs-on: ubuntu-latest
    needs: spark
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["4.0"]
        platform: ["linux/amd64,linux/arm64,linux/riscv64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./benchmarks/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}

  media-streaming:
    runs-on: ubuntu-latest
    needs: base-os
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["client", "server", "dataset"]
        platform: ["linux/amd64,linux/arm64,linux/riscv64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./benchmarks/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}
  
  web-search:
    runs-on: ubuntu-latest
    needs: [faban, java]
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["client", "server", "dataset"]
        platform: ["linux/amd64,linux/arm64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./benchmarks/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}
  
  web-serving:
    runs-on: ubuntu-latest
    needs: [faban, mysql, memcached]
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["db_server", "faban_client", "memcached_server", "web_server"]
        platform: ["linux/amd64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./benchmarks/${{ github.job }}/${{ matrix.tag }}"
          DBX_PLATFORM: ${{ matrix.platform }}
  
  movielens-dataset:
    runs-on: ubuntu-latest
    needs: base-os
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["latest"]
        platform: ["linux/amd64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./datasets/${{ github.job }}"
          DBX_PLATFORM: ${{ matrix.platform }}
  
  twitter-dataset-graph:
    runs-on: ubuntu-latest
    needs: base-os
    env:
      DH_REPO: "cloudsuitetest/${{ github.job }}"
    strategy:
      matrix:
        tag: ["latest"]
        platform: ["linux/amd64"]
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v1
      - name: build and push
        run: "./.github/scripts/build-images.sh"
        env:
          IMG_TAG: "${{ matrix.tag }}"
          DF_PATH: "./datasets/${{ github.job }}"
          DBX_PLATFORM: ${{ matrix.platform }}
